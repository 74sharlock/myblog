// Generated by CoffeeScript 1.9.2
(function() {
  define(function(require, exports, module) {
    var Alert, forumCommentImageList, getDomClone, leftCount, li, looksBtn, maxImageLength, updateLeftCount;
    maxImageLength = 9;
    forumCommentImageList = document.getElementById('forumCommentImageList');
    li = forumCommentImageList.getElementsByTagName('li')[0];
    leftCount = document.getElementById('leftCount');
    looksBtn = document.getElementById('looksBtn');
    Alert = require('global/alert.js');
    forumCommentImageList.removeChild(li);
    window.imageUploadList = [];
    updateLeftCount = function() {
      var count, em;
      em = leftCount.querySelector('em');
      count = maxImageLength - forumCommentImageList.getElementsByTagName('li').length;
      if (count === maxImageLength) {
        leftCount.classList.add('hidden');
      } else {
        leftCount.classList.remove('hidden');
      }
      return em.innerHTML = count;
    };
    getDomClone = function(dom, callback) {
      var domClone, node;
      if (Object.prototype.toString.call(dom).indexOf('Element') > 0) {
        node = dom.nodeName.toLowerCase();
        domClone = document.createElement(node);
        domClone.innerHTML = dom.innerHTML;
        if (callback) {
          callback(domClone);
        }
        return domClone;
      }
    };
    return function() {
      var $, addImgBtn, api, communityId, global, imgUpload, upLoadImg;
      imgUpload = document.getElementById('imgUpload');
      addImgBtn = document.getElementById('addImgBtn');
      addImgBtn.addEventListener('click', function() {
        if (window.imageUploadList.length > maxImageLength - 1) {
          alert('抱歉，最多只能上传' + maxImageLength + '张图片.');
          return false;
        }
      }, false);
      $ = require('$');
      communityId = $("#wsqid").val();
      api = require('api');
      global = require('global');
      $(".looks-block .list-unstyled a").click(function() {
        var $this;
        require('global/insertAtCursor.js');
        $this = $(this);
        return $("#content").insertAtCursor($this.data("icon"));
      });
      $("#submitBtn").click(function() {
        if ($.trim($("#content").val()) !== '') {
          return $.post(api.wsqTopicAdd(communityId), {
            "labels": "",
            "communityId": communityId,
            "content": global.htmlEncode($("#content").val()),
            "images": window.imageUploadList.join(',')
          }, function(data) {
            data = JSON.parse(data);
            if (!data.ResponseID) {
              location.href = api.wsqDetailUrl(data.Data.Id);
            } else {
              alert(data['Message']);
            }
            return null;
          });
        } else {
          return Alert('主题内容不能为空', 2000, true, true);
        }
      });
      imgUpload.addEventListener('change', function(e) {
        var file, fr;
        file = e.target.files[0];
        fr = new FileReader();
        fr.onload = function() {
          upLoadImg(file, this.result);
          return null;
        };
        return fr.readAsDataURL(file);
      }, false);
      looksBtn.addEventListener('click', function() {
        var looksBlock;
        looksBlock = document.querySelector('.looks-block');
        looksBlock.classList.toggle('active');
        return null;
      }, false);
      upLoadImg = function(file, localSource) {
        var bar, i, imgLi, mask, url;
        imgLi = getDomClone(li);
        bar = imgLi.querySelector('.progress-bar');
        mask = imgLi.querySelector('.mask');
        i = imgLi.querySelector('i');
        url = require('api').imageUploadUrl('user');
        return require('global/fileUpload.js')({
          url: url,
          file: file,
          fileSize: 3145728,
          outOfSize: function() {
            return require('global/alert.js')('您上传的图片太大!', 2000, true, true);
          },
          beforeUpload: function() {
            if (forumCommentImageList.getElementsByTagName('li').length === maxImageLength - 1) {
              addImgBtn.style.display = 'none';
            }
            forumCommentImageList.appendChild(imgLi);
            imgLi.querySelector('img').src = localSource;
            imgLi.querySelector('i').classList.add('hidden');
            updateLeftCount();
            imgLi.querySelector('i').addEventListener('click', function() {
              var index, j, len, list, ref, x;
              x = 0;
              ref = forumCommentImageList.getElementsByTagName('li');
              for (j = 0, len = ref.length; j < len; j++) {
                list = ref[j];
                if (imgLi === forumCommentImageList.getElementsByTagName('li')[x]) {
                  index = x;
                }
              }
              imgLi.parentNode.removeChild(imgLi);
              window.imageUploadList.splice(index, 1);
              updateLeftCount();
              if (window.imageUploadList.length < maxImageLength) {
                return addImgBtn.style.display = 'inline-block';
              }
            }, false);
            return imgUpload.value = '';
          },
          onSuccess: function(data) {
            var barCon;
            barCon = bar.parentNode;
            barCon.style.opacity = '1';
            barCon.style.transition = 'opacity 1s ease-in-out';
            barCon.style.webkitTransitionProperty = 'opacity';
            barCon.style.webkitTransitionDuration = '1s';
            barCon.style.webkitTransitionTimingFunction = 'ease-in-out';
            barCon.style.opacity = '0';
            barCon.addEventListener('transitionend', function() {
              barCon.parentNode.removeChild(barCon);
              return mask.style.display = 'none';
            });
            false;
            barCon.addEventListener('webkitTransitionEnd', function() {
              barCon.parentNode.removeChild(barCon);
              return mask.style.display = 'none';
            });
            false;
            window.imageUploadList.push(data['path']);
            updateLeftCount();
            return i.classList.remove('hidden');
          },
          onProgress: function(num) {
            bar.setAttribute('aria-valuenow', num);
            bar.style.width = num + '%';
            return bar.querySelector('.sr-only').innerHTML = num + '% 完成';
          },
          onError: function() {
            Alert('上传失败,请稍后再试.', 2000, true, true);
            return i.classList.remove('hidden');
          }
        });
      };
      return null;
    };
  });

}).call(this);

//# sourceMappingURL=addAction.js.map
